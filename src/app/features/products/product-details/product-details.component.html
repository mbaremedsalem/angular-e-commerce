<div class="product-detail-container">
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <div *ngIf="product && !isLoading" class="product-content">
    <!-- Gallery Produit -->
    <div class="product-gallery">
      <div class="main-image">
        <img [src]="product.images[activeImageIndex].image" [alt]="product.name">
      </div>
      <div class="thumbnail-container">
        <div *ngFor="let image of product.images; let i = index" 
             class="thumbnail" 
             [class.active]="i === activeImageIndex"
             (click)="setActiveImage(i)">
          <img [src]="image.image" [alt]="'Thumbnail ' + (i + 1)">
        </div>
      </div>
    </div>

    <!-- Détails Produit -->
    <div class="product-info">
      <h1>{{ product.name }}</h1>
      <p class="brand">Marque: {{ product.brand }}</p>
      
      <div class="price-section">
        <span class="current-price">{{ product.price }} MRU</span>
        <span *ngIf="product.old_price" class="old-price">{{ product.old_price }} MRU</span>
      </div>

      <div class="rating">
        <div class="stars">
          <span *ngFor="let star of [1,2,3,4,5]" 
                [class.filled]="star <= numericRating">★</span>
        </div>
        <span class="rating-value">{{ numericRating | number:'1.1-1' }} ({{ product.reviews.length }} avis)</span>
      </div>

      <div class="stock-status">
        <span [class.in-stock]="product.stock > 0" [class.out-of-stock]="product.stock <= 0">
          {{ product.stock > 0 ? 'En stock (' + product.stock + ' disponibles)' : 'Rupture de stock' }}
        </span>
      </div>

      <!-- Sélection de taille -->
      <div class="size-selector" *ngIf="product.sizes.length > 0">
        <h3>Taille</h3>
        <div class="size-options">
          <button *ngFor="let size of product.sizes" 
                  [class.selected]="selectedSize === size.code"
                  (click)="selectSize(size.code)">
            {{ size.code }}
          </button>
        </div>
      </div>

      <!-- Sélection de couleur -->
      <div class="color-selector" *ngIf="product.colors.length > 0">
        <h3>Couleur</h3>
        <div class="color-options">
          <button *ngFor="let color of product.colors" 
                  [style.background-color]="color.hex_code"
                  [class.selected]="selectedColor === color.name"
                  (click)="selectColor(color.name)"
                  [title]="color.name">
          </button>
        </div>
      </div>

      <!-- Quantité -->
      <div class="quantity-selector">
        <h3>Quantité</h3>
        <div class="quantity-control">
          <button (click)="decrementQuantity()">-</button>
          <span>{{ quantity }}</span>
          <button (click)="incrementQuantity()">+</button>
        </div>
      </div>

      <p class="description">{{ product.description }}</p>

      <button (click)="addToCart()" class="add-to-cart" 
              [disabled]="product.stock <= 0 || !selectedSize || !selectedColor">
        Ajouter au panier
      </button>
    </div>
  </div>

  <!-- Section Avis -->
  <div *ngIf="product" class="reviews-section">
    <h2>Avis clients</h2>
    
    <div *ngIf="product.reviews.length === 0" class="no-reviews">
      <p>Aucun avis pour le moment. Soyez le premier à donner votre avis !</p>
    </div>

    <div *ngFor="let review of product.reviews" class="review-card">
      <div class="review-header">
        <div class="review-rating">
          <span *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= review.rating">★</span>
        </div>
        <span class="review-date">{{ review.createedAt | date:'dd/MM/yyyy' }}</span>
      </div>
      <p class="review-comment">{{ review.comment }}</p>
      <p class="review-author">Par {{ review.user_name || 'Anonyme' }}</p>
    </div>

    <!-- Formulaire d'avis -->
    <div *ngIf="isAuthenticated" class="review-form-container">
      <h3>Donnez votre avis</h3>
      
      <div *ngIf="reviewSuccess" class="success-message">
        Merci pour votre avis !
      </div>
      
      <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="review-form">
        <div class="form-group">
          <label>Votre note</label>
          <div class="rating-input">
            <span *ngFor="let star of [1,2,3,4,5]" 
                  (click)="reviewForm.get('rating')?.setValue(star)"
                  [class.selected]="star <= reviewForm.get('rating')?.value">★</span>
          </div>
          <div *ngIf="reviewForm.get('rating')?.invalid && reviewForm.get('rating')?.touched" 
               class="error-message">
            Veuillez sélectionner une note
          </div>
        </div>

        <div class="form-group">
          <label for="comment">Votre avis</label>
          <textarea id="comment" formControlName="comment" rows="5"></textarea>
          <div *ngIf="reviewForm.get('comment')?.invalid && reviewForm.get('comment')?.touched" 
               class="error-message">
            Veuillez écrire un avis (minimum 10 caractères)
          </div>
        </div>

        <button type="submit" class="submit-review" [disabled]="isSubmittingReview || reviewForm.invalid">
          <span *ngIf="!isSubmittingReview">Soumettre l'avis</span>
          <span *ngIf="isSubmittingReview">Envoi en cours...</span>
        </button>

        <div *ngIf="reviewError" class="error-message">
          {{ reviewError }}
        </div>
      </form>
    </div>

    <div *ngIf="!isAuthenticated" class="login-prompt">
      <p>Veuillez vous <a routerLink="/login">connecter</a> pour donner votre avis.</p>
    </div>
  </div>
</div>